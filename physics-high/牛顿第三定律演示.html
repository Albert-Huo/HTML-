<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>ç‰›é¡¿ç¬¬ä¸‰å®šå¾‹ï¼š150Næé™æŒ‘æˆ˜</title>
<style>
  :root{
    --card-bg: rgba(255,255,255,0.08);
    --accent:#3ddc97; --warn:#ffb74d; --error:#ff6b6b; --ink:#e9f2ff;
    --panel-bg: rgba(20,20,20,0.85);
  }
  body{ background:#1a1a1a; color:#fff; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial,Helvetica,sans-serif; margin:0; padding:10px; display:flex; flex-direction:column; align-items:center; user-select: none; overflow-x: hidden;}

  /* é¡¶éƒ¨å½©å¸¦ */
  #spectrum{
    position: relative; width: 100%; max-width: 900px; height: 40px; border-radius: 10px; overflow: hidden;
    box-shadow: 0 0 15px rgba(255,255,255,0.15); background: #000; 
    margin: 0 0 12px; flex-shrink: 0;
  }
  #spectrum::before{
    content: ""; position: absolute; inset: 0; border-radius: inherit;
    background: linear-gradient(90deg, 
      #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000,
      #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000
    );
    background-size: 200% 100%;
    animation: flowRainbow 6s linear infinite;
  }
  @keyframes flowRainbow { 
    0% { background-position: 0% 0; }
    100% { background-position: -100% 0; }
  }

  /* ä»»åŠ¡å¡ */
  .task-card{ width:100%; max-width:900px; background:var(--card-bg); border:1px solid rgba(255,255,255,0.12); border-radius:12px; padding:12px 14px; backdrop-filter:blur(6px);
    display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:center; transition:opacity .2s, filter .2s;}
  .task-step{ background:rgba(255,255,255,0.15); border-radius:8px; padding:6px 10px; font-weight:600; white-space:nowrap; }
  .task-text{ line-height:1.55; } .task-hint{ color:#ffd54f; font-size:12px; opacity:.9; }
  .progress-dots{ display:flex; gap:6px; align-items:center; }
  .dot{ width:10px; height:10px; border-radius:50%; background:rgba(255,255,255,0.25); outline:2px solid rgba(255,255,255,0.15); }
  .dot.active{ background:var(--warn);} .dot.done{ background:var(--accent); outline-color:rgba(61,220,151,0.5);}

  /* ç”»å¸ƒåŒºåŸŸ */
  #canvasWrap{ width:100%; max-width:900px; height:55vh; max-height:480px; margin-top:10px; }
  #canvas{ width:100%; height:100%; background:#2c2c2c; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.3); position:relative; overflow:hidden; touch-action:none; cursor: default;
    background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
  }
  
  /* å¢™å£ */
  .wall-mount {
    position: absolute; right: 0; top: 0; bottom: 0; width: 30px; 
    background: repeating-linear-gradient(45deg, #444, #444 10px, #333 10px, #333 20px);
    border-left: 4px solid #111; box-shadow: -5px 0 15px rgba(0,0,0,0.6); z-index: 5;
  }
  .mount-loop {
    position: absolute; top: 50%; right: 10px; width: 20px; height: 16px; border: 4px solid #888; border-right: none; border-radius: 50% 0 0 50%; transform: translateY(-50%);
  }

  /* --- æµ‹åŠ›è®¡ç»„ä»¶ --- */
  .scale-wrapper {
    position: absolute; top: 50%; transform: translateY(-50%);
    width: 260px; /* ç¨å¾®åŠ å®½ä¸€ç‚¹ */
    height: 90px;
    display: flex; flex-direction: column; 
    transition: transform 0.05s linear;
  }

  .scale-casing {
    width: 100%; height: 100%; border-radius: 8px;
    border: 3px solid #333;
    display: flex; flex-direction: column;
    box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    position: relative; z-index: 2;
    background: #333; 
  }

  .readout-panel {
    height: 36px; width: 100%;
    border-bottom: 2px solid rgba(0,0,0,0.1);
    display: flex; align-items: center; justify-content: flex-end;
    padding: 0 10px; box-sizing: border-box;
  }
  .lcd-screen {
    background: #000; color: #0f0; font-family: 'Courier New', monospace; font-weight: bold; font-size: 18px;
    padding: 2px 8px; border-radius: 4px; border: 1px solid #555; box-shadow: inset 0 0 4px rgba(0,255,0,0.2);
    min-width: 70px; text-align: right; letter-spacing: 1px;
  }
  .scale-label { margin-right: auto; font-size: 10px; font-weight: bold; text-transform: uppercase; color: rgba(0,0,0,0.5); letter-spacing: 1px; }

  .spring-window {
    flex: 1; position: relative; overflow: hidden;
    background: rgba(0,0,0,0.05); border-radius: 0 0 6px 6px;
  }
  
  .spring-coil {
    position: absolute; top: 50%; left: 0; height: 14px; transform: translateY(-50%);
    background: repeating-linear-gradient(90deg, transparent, transparent 3px, #555 3px, #555 5px);
    width: 20px; transform-origin: left center;
  }

  /* æ‹‰æ†åŠ é•¿ä»¥é€‚åº”æ›´å¤§æ‹‰åŠ› */
  .internal-rod {
    position: absolute; top: 50%; height: 4px; background: #666; transform: translateY(-50%);
    left: 20px; width: 300px; /* åŠ é•¿ */
  }

  /* æŒ‚é’©ç³»ç»Ÿ */
  .hook-assembly { position: absolute; top: 50%; transform: translateY(-50%); width: 30px; height: 20px; z-index: 1; }
  .metal-hook {
    width: 16px; height: 16px; border: 4px solid #aaa; border-radius: 50%;
    position: absolute; background: linear-gradient(135deg, #ccc 0%, #888 100%);
    box-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    mask: radial-gradient(transparent 55%, black 60%); -webkit-mask: radial-gradient(transparent 55%, black 60%);
  }
  .metal-hook::after { content:''; position: absolute; width: 10px; height: 10px; background: #2c2c2c; }

  /* å³æµ‹åŠ›è®¡ */
  #scaleRight { right: 32px; transform-origin: right center; pointer-events: none; }
  #scaleRight .scale-casing { background: #ffebee; border-color: #ef5350; }
  #scaleRight .lcd-screen { color: #ff5252; box-shadow: inset 0 0 4px rgba(255,0,0,0.2); }
  #scaleRight .spring-coil { right: 10px; left: auto; transform-origin: right center; }
  #scaleRight .internal-rod { right: 30px; left: auto; }
  #scaleRight .hook-assembly { left: -14px; } 
  #scaleRight .metal-hook { transform: rotate(45deg); border-color: #888; }
  #scaleRight .metal-hook::after { top: 20%; left: -50%; transform: rotate(0deg); }

  /* å·¦æµ‹åŠ›è®¡ (å¯æ‹–åŠ¨) */
  #scaleLeft { right: 302px; z-index: 10; cursor: grab; } /* åˆå§‹ä½ç½®å³ç§»é€‚åº”æ›´å®½çš„ç»„ä»¶ */
  #scaleLeft:active { cursor: grabbing; }
  #scaleLeft .scale-casing { background: #e3f2fd; border-color: #42a5f5; transition: border-color 0.2s, box-shadow 0.2s;}
  #scaleLeft.highlight .scale-casing { border-color: #fff; box-shadow: 0 0 15px rgba(66, 165, 245, 0.6); }
  
  #scaleLeft .lcd-screen { color: #448aff; }
  #scaleLeft .spring-coil { left: 10px; transform-origin: left center; }
  #scaleLeft .internal-rod { left: 30px; }
  #scaleLeft .hook-assembly { right: -14px; }
  #scaleLeft .metal-hook { transform: rotate(225deg); border-color: #888; }
  #scaleLeft .metal-hook::after { top: 20%; left: -50%; }

  /* æ‰‹ */
  .hand-grip {
    position: absolute; left: -50px; top: 50%; transform: translateY(-50%);
    font-size: 54px; filter: drop-shadow(-4px 4px 4px rgba(0,0,0,0.4));
    pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€åˆ° scaleLeft å®¹å™¨ */
    transition: transform 0.1s;
  }
  #scaleLeft:active .hand-grip { transform: translateY(-50%) scale(0.9); }
  
  /* äº¤äº’æç¤ºæŒ‡å¼• */
  .drag-hint {
    position: absolute; left: 10%; top: 65%; color: rgba(255,255,255,0.5); font-size: 14px;
    display: flex; align-items: center; gap: 8px; pointer-events: none;
    animation: fadePulse 2s infinite;
  }
  .drag-arrow { width: 40px; height: 2px; background: rgba(255,255,255,0.3); position: relative; }
  .drag-arrow::before { content:''; position: absolute; left: 0; top: -4px; border-right: 8px solid rgba(255,255,255,0.3); border-top: 5px solid transparent; border-bottom: 5px solid transparent; }
  @keyframes fadePulse { 0%,100%{opacity:0.3} 50%{opacity:0.8} }

  /* é’©å­å’¬åˆå¾®è°ƒ */
  #hookRight { top: 0; left: 0; }
  #hookLeft  { top: 2px; left: 2px; }

  /* çŠ¶æ€ (å¤ç”¨) */
  .checkmark{ position:absolute; z-index:50; left:50%; top:40%; transform:translate(-50%,-50%) scale(.6); width:120px; height:120px; border-radius:50%; background:rgba(61,220,151,.15);
    border:3px solid var(--accent); display:none; align-items:center; justify-content:center; box-shadow:0 0 40px rgba(61,220,151,.45), inset 0 0 20px rgba(61,220,151,.25); animation:pop .55s ease-out;}
  .checkmark.active{ display:flex;} .checkmark>div{ width:60px; height:30px; border-left:8px solid var(--accent); border-bottom:8px solid var(--accent); transform:rotate(-45deg) translateY(-6px); }
  @keyframes pop{ 0%{transform:translate(-50%,-50%) scale(.4);opacity:.2}60%{transform:translate(-50%,-50%) scale(1.08);opacity:1}100%{transform:translate(-50%,-50%) scale(1)} }
  
  .toolbar{ width:100%; max-width:900px; margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; }
  .toolbar button{ padding:10px 16px; background:#444; color:#fff; border:none; border-radius:8px; cursor:pointer; transition:background .25s, transform .05s, opacity .2s; user-select:none;}
  .toolbar button:hover{ background:#5a5a5a;} .toolbar button:active{ transform:scale(.98);} .toolbar button:disabled{ opacity:.5; cursor:not-allowed;}

  .toast{ position:fixed; left:50%; bottom:24px; transform:translateX(-50%) translateY(20px); background:rgba(0,0,0,0.8); color:#fff; padding:10px 14px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,.35);
    font-size:14px; opacity:0; pointer-events:none; transition:opacity .25s, transform .25s; z-index:200;}
  .toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }

  .modal-mask{ position:fixed; inset:0; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index:300; }
  .modal{ width:min(90vw,360px); background:#111; color:#fff; border:1px solid rgba(255,255,255,.15); border-radius:14px; padding:18px 16px; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,.5);}
  .modal h3{ margin:8px 0 6px; font-size:20px;} .modal p{ color:#cfd8dc; margin-top:0;} .modal .ok{ margin-top:12px; background:var(--accent); color:#081a12; font-weight:700; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;}

  .explanation{ width:100%; max-width:900px; margin:14px 0 20px; line-height:1.65; font-size:.95em; color:var(--ink);}
  .explanation h2{ margin:.2em 0 .4em; color:#9bd3ff; font-size:1.15em;} 
</style>
</head>
<body>
  <div id="spectrum"></div>

  <div class="task-card" id="taskCard">
    <div class="task-step" id="taskStep">æ­¥éª¤ 1 / 3</div>
    <div class="task-text">
      <div id="taskText">æŒ‰ä½å·¦è¾¹çš„æ‰‹æŸ„<strong>å‘å·¦æ‹–åŠ¨</strong>ï¼Œè¾¾åˆ° <strong>50N</strong> å·¦å³ã€‚</div>
      <div class="task-hint" id="taskHint">æç¤ºï¼šæ–°çš„å¼¹ç°§æ›´é•¿ï¼Œéœ€è¦æ‹–åŠ¨æ›´è¿œçš„è·ç¦»ã€‚</div>
    </div>
    <div class="progress-dots">
      <span class="dot active" id="dot1"></span><span class="dot" id="dot2"></span><span class="dot" id="dot3"></span>
    </div>
  </div>

  <div id="canvasWrap">
    <div id="canvas">
      
      <div class="wall-mount">
        <div class="mount-loop"></div>
      </div>

      <div class="scale-wrapper" id="scaleRight">
        <div class="hook-assembly" id="hookAssyRight">
          <div class="metal-hook" id="hookRight"></div>
        </div>
        <div class="scale-casing">
          <div class="readout-panel">
            <span class="scale-label">WALL FORCE</span>
            <div class="lcd-screen" id="readoutRight">0.0</div>
          </div>
          <div class="spring-window">
            <div class="spring-coil" id="coilRight"></div>
            <div class="internal-rod" id="rodRight"></div>
          </div>
        </div>
      </div>

      <div class="scale-wrapper" id="scaleLeft">
        <div class="hand-grip">ğŸ‘ˆ</div> <div class="scale-casing">
          <div class="readout-panel">
            <span class="scale-label">YOUR FORCE</span>
            <div class="lcd-screen" id="readoutLeft">0.0</div>
          </div>
          <div class="spring-window">
            <div class="spring-coil" id="coilLeft"></div>
            <div class="internal-rod" id="rodLeft"></div>
          </div>
        </div>
        <div class="hook-assembly" id="hookAssyLeft">
          <div class="metal-hook" id="hookLeft"></div>
        </div>
      </div>

      <div class="drag-hint">
        <div class="drag-arrow"></div>
        <span>æŒ‰ä½å‘å·¦æ‹‰</span>
      </div>
      
      <div class="checkmark" id="checkmark"><div></div></div>
    </div>
  </div>

  <div class="toolbar">
    <button id="resetBtn">æ­¥éª¤é‡ç½®</button>
    <button id="autoDemoBtn">è‡ªåŠ¨æ¼”ç¤º</button>
    <button id="freeBtn">è‡ªç”±æ¨¡å¼</button>
  </div>

  <div class="toast" id="toast">è¯·æŒ‰ä½å·¦è¾¹çš„æ‰‹æŸ„å‘å·¦æ‹‰</div>

  <div class="modal-mask" id="doneMask">
    <div class="modal">
      <h3 id="doneTitle">æé™æŒ‘æˆ˜æˆåŠŸï¼ğŸ‰</h3>
      <p>å³ä½¿è¾¾åˆ°150Nçš„æé™æ‹‰åŠ›ï¼Œ<br>å¢™å£å¯¹ä½ çš„æ‹‰åŠ›ä¾ç„¶å’Œä½ æ‹‰å¢™å£çš„åŠ›<strong>åˆ†æ¯«ä¸å·®</strong>ã€‚</p>
      <button class="ok" id="okBtn">æ˜ç™½</button>
    </div>
  </div>

  <div class="explanation">
    <h2>150N çš„å¼¹ç°§å‘Šè¯‰æˆ‘ä»¬ä»€ä¹ˆï¼Ÿ</h2>
    <ul>
      <li><strong>èƒ¡å…‹å®šå¾‹ (F=kx)</strong>ï¼šåŠ›è¶Šå¤§ï¼Œå¼¹ç°§ä¼¸å¾—è¶Šé•¿ã€‚åœ¨150Næ—¶ï¼Œä½ èƒ½æ˜æ˜¾çœ‹åˆ°å¼¹ç°§çš„å·¨å¤§å½¢å˜ã€‚</li>
      <li><strong>æ’ç­‰å…³ç³»</strong>ï¼šæ— è®ºæ˜¯åœ¨ 10N è¿˜æ˜¯ 150Nï¼Œä¸¤ä¸ªå±å¹•çš„æ•°å­—æ€»æ˜¯åŒæ­¥çš„ã€‚è¿™è¯´æ˜ä½œç”¨åŠ›ä¸åä½œç”¨åŠ›çš„ç›¸ç­‰å…³ç³»ä¸åŠ›çš„å¤§å°æ— å…³ã€‚</li>
    </ul>
  </div>

<script>
/* ====== å¸¸é‡å®šä¹‰ ====== */
const MAX_FORCE = 150;      // æ–°çš„æé™å€¼
const MAX_EXTENSION = 140;  // è§†è§‰ä¸Šçš„æœ€å¤§ä¼¸é•¿é‡ (px)
const SCALE_LEFT_START = 302; // å·¦æµ‹åŠ›è®¡åˆå§‹ right å€¼

/* ====== çŠ¶æ€ç®¡ç† ====== */
const state = {
  force: 0,
  step: 0,
  freeMode: false,
  autoMode: false,
  completed: false,
  isDragging: false,
  dragStartX: 0,
  initialDisplacement: 0,
};

/* ====== DOM å…ƒç´  ====== */
const UI = {
  // Left Scale (Active)
  scaleLeft: document.getElementById('scaleLeft'),
  coilLeft: document.getElementById('coilLeft'),
  rodLeft: document.getElementById('rodLeft'),
  hookAssyLeft: document.getElementById('hookAssyLeft'),
  readoutLeft: document.getElementById('readoutLeft'),
  
  // Right Scale (Passive)
  scaleRight: document.getElementById('scaleRight'),
  coilRight: document.getElementById('coilRight'),
  rodRight: document.getElementById('rodRight'),
  hookAssyRight: document.getElementById('hookAssyRight'),
  readoutRight: document.getElementById('readoutRight'),
  
  dragHint: document.querySelector('.drag-hint'),
  
  dots: [document.getElementById('dot1'), document.getElementById('dot2'), document.getElementById('dot3')],
  taskText: document.getElementById('taskText'),
  taskHint: document.getElementById('taskHint'),
  stepCount: document.getElementById('taskStep'),
  
  toast: document.getElementById('toast'),
  check: document.getElementById('checkmark'),
  modal: document.getElementById('doneMask')
};

/* ====== ä»»åŠ¡å®šä¹‰ ====== */
const tasks = [
  {
    text: "å°è¯•æ‹‰åŠ¨å¼¹ç°§ï¼Œå°†æ‹‰åŠ›æ§åˆ¶åœ¨ <strong>50N</strong> å·¦å³ (Â±5N)ã€‚",
    hint: "æ…¢æ…¢å‘å·¦æ‹–åŠ¨ï¼Œæ„Ÿå—å¼¹ç°§çš„é˜»åŠ›ã€‚",
    check: (f) => f >= 45 && f <= 55,
    duration: 600
  },
  {
    text: "æé™æŒ‘æˆ˜ï¼ç”¨åŠ›æ‹‰åˆ° <strong>150N (æœ€å¤§å€¼)</strong>ã€‚",
    hint: "çœ‹ï¼å¼¹ç°§è¢«æ‹‰å¾—éå¸¸é•¿ï¼ŒæŒ‚é’©ä¾ç„¶ç´§ç´§å’¬åˆã€‚",
    check: (f) => f >= 148,
    duration: 800
  },
  {
    text: "ç²¾ç»†å›å¼¹ï¼šæ…¢æ…¢æ¾æ‰‹ï¼Œè®©è¯»æ•°å›åˆ° <strong>30N</strong> (Â±3N)ã€‚",
    hint: "è¿™éœ€è¦å¾ˆå¥½çš„æ§åˆ¶åŠ›ï¼Œè§‚å¯Ÿä¸¤ä¸ªè¯»æ•°æ˜¯å¦ä¾ç„¶ç›¸ç­‰ã€‚",
    check: (f) => f >= 27 && f <= 33,
    duration: 1000
  }
];

/* ====== ç‰©ç†æ¸²æŸ“æ ¸å¿ƒ ====== */
function updatePhysics(newForce) {
  // é™åˆ¶åŠ›åœ¨ 0 - MAX_FORCE ä¹‹é—´
  state.force = Math.max(0, Math.min(MAX_FORCE, newForce));
  
  // 1. æ•°å€¼æ˜¾ç¤º
  const valStr = state.force.toFixed(1);
  UI.readoutLeft.textContent = valStr;
  UI.readoutRight.textContent = valStr;

  // 2. ç‰©ç†ä½ç§»è®¡ç®—
  // å½“å‰ä¼¸é•¿é‡ (px) = (å½“å‰åŠ› / æœ€å¤§åŠ›) * æœ€å¤§ä¼¸é•¿é‡
  const currentExt = (state.force / MAX_FORCE) * MAX_EXTENSION;
  
  // --- å³æµ‹åŠ›è®¡ (å›ºå®šä¾§) ---
  // å¼¹ç°§ä¼¸é•¿
  UI.coilRight.style.width = (20 + currentExt) + "px"; 
  UI.rodRight.style.right = (30 + currentExt) + "px";
  // æŒ‚é’©å‘å·¦ä¼¸å‡º
  UI.hookAssyRight.style.left = (-14 - currentExt) + "px";

  // --- å·¦æµ‹åŠ›è®¡ (æ‹–åŠ¨ä¾§) ---
  // å¤–å£³ä½ç½® = åˆå§‹ + (å³å¼¹ç°§ä¼¸é•¿ + å·¦å¼¹ç°§ä¼¸é•¿)
  // å› ä¸º F ç›¸åŒï¼Œk ç›¸åŒï¼Œæ‰€ä»¥ä¸¤è¾¹ä¼¸é•¿é‡ç›¸åŒã€‚æ€»ä½ç§» = 2 * currentExt
  UI.scaleLeft.style.right = (SCALE_LEFT_START + currentExt * 2) + "px";

  // å†…éƒ¨æ„ä»¶
  UI.coilLeft.style.width = (20 + currentExt) + "px";
  UI.rodLeft.style.left = (30 + currentExt) + "px";
  UI.hookAssyLeft.style.right = (-14 - currentExt) + "px";
  
  // 3. ä»»åŠ¡æ£€æŸ¥ (ä¸åœ¨è‡ªåŠ¨æ¼”ç¤ºä¸”æœªå®Œæˆæ—¶æ£€æŸ¥)
  if (!state.freeMode && !state.autoMode && !state.completed) {
    checkTask();
  }
}

/* ====== æ‹–æ‹½äº¤äº’é€»è¾‘ ====== */
function startDrag(e) {
  if (state.autoMode) return;
  state.isDragging = true;
  state.dragStartX = getClientX(e);
  
  // åç®—å‡ºå½“å‰çš„åŠ›å¯¹åº”çš„â€œè™šæ‹Ÿâ€ä½ç§»ï¼Œä¿è¯è¿ç»­æ€§
  // ä½ç§»æ¯”ä¾‹ï¼š150N å¯¹åº”çš„æ€»å±å¹•æ‹–åŠ¨è·ç¦»ä¸º (MAX_EXTENSION * 2) = 280px
  // ä¹Ÿå°±æ˜¯è¯´ç”¨æˆ·éœ€è¦æ‹–åŠ¨ 280px æ‰èƒ½è¾¾åˆ°æ»¡é‡ç¨‹ï¼Œæ‰‹æ„Ÿæ¯”è¾ƒçœŸå®
  const totalPixels = MAX_EXTENSION * 2;
  const currentDisplacement = (state.force / MAX_FORCE) * totalPixels;
  state.initialDisplacement = currentDisplacement;
  
  UI.scaleLeft.classList.add('highlight');
  UI.dragHint.style.opacity = 0; 
}

function onDrag(e) {
  if (!state.isDragging) return;
  e.preventDefault(); 
  
  const currentX = getClientX(e);
  const deltaX = state.dragStartX - currentX; // å‘å·¦æ‹‰ï¼ŒdeltaX > 0
  
  // è®¡ç®—æ–°çš„æ€»ä½ç§»
  let totalDisplacement = state.initialDisplacement + deltaX;
  totalDisplacement = Math.max(0, totalDisplacement); 
  
  // æ˜ å°„å›åŠ›
  const totalPixels = MAX_EXTENSION * 2;
  const newForce = (totalDisplacement / totalPixels) * MAX_FORCE;
  
  updatePhysics(newForce);
}

function stopDrag() {
  if (!state.isDragging) return;
  state.isDragging = false;
  UI.scaleLeft.classList.remove('highlight');
  
  // è‡ªåŠ¨å›å¼¹
  if (!state.autoMode) {
     snapBack();
  }
}

function snapBack() {
  // ç®€å•çš„å›å¼¹åŠ¨ç”»
  if (state.force > 0) {
    const startF = state.force;
    const startTime = performance.now();
    const duration = 400; // ms
    
    function animateSnap(time) {
      if (state.isDragging || state.autoMode) return; // è¢«æ‰“æ–­
      const elapsed = time - startTime;
      const progress = Math.min(elapsed / duration, 1);
      // Ease Out
      const ease = 1 - Math.pow(1 - progress, 3);
      
      const currentF = startF * (1 - ease);
      updatePhysics(currentF);
      
      if (progress < 1) requestAnimationFrame(animateSnap);
    }
    requestAnimationFrame(animateSnap);
  }
}

function getClientX(e) {
  return e.touches ? e.touches[0].clientX : e.clientX;
}

// ç»‘å®šäº‹ä»¶
const target = UI.scaleLeft;
target.addEventListener('mousedown', startDrag);
target.addEventListener('touchstart', startDrag, {passive: false});
window.addEventListener('mousemove', onDrag, {passive: false});
window.addEventListener('touchmove', onDrag, {passive: false});
window.addEventListener('mouseup', stopDrag);
window.addEventListener('touchend', stopDrag);


/* ====== ä»»åŠ¡åˆ¤å®š ====== */
let checkTimer = null;
function checkTask() {
  // å®‰å…¨æ£€æŸ¥ï¼šé˜²æ­¢ step è¶…å‡ºèŒƒå›´
  if (state.step >= tasks.length) return;

  const current = tasks[state.step];
  if (current.check(state.force)) {
    if (!checkTimer) {
      checkTimer = setTimeout(() => {
        completeStep();
        checkTimer = null;
      }, current.duration);
    }
  } else {
    if (checkTimer) {
      clearTimeout(checkTimer);
      checkTimer = null;
    }
  }
}

function completeStep() {
  // é˜²æ­¢é‡å¤å®Œæˆ
  if (state.step >= tasks.length) return;

  showCheck();
  
  // å…³é”®ä¿®å¤ï¼šå¦‚æœåœ¨éè‡ªåŠ¨æ¨¡å¼ï¼Œä¸ºäº†é˜²æ­¢ check å®Œæˆçš„ç¬é—´å› ä¸º snapBack å¯¼è‡´åŠ›è·³å˜ï¼Œ
  // æˆ‘ä»¬æš‚æ—¶å‡è£…æ­£åœ¨æ‹–åŠ¨ï¼Œå»¶è¿Ÿå›å¼¹
  if (!state.autoMode) {
    state.isDragging = true; 
    setTimeout(()=>{ state.isDragging = false; snapBack(); }, 600);
  }

  setTimeout(() => {
    // UI æ›´æ–°
    UI.dots[state.step].classList.remove('active');
    UI.dots[state.step].classList.add('done');
    
    state.step++;
    if (state.step >= tasks.length) {
      state.completed = true;
      showDone();
    } else {
      UI.dots[state.step].classList.add('active');
      const t = tasks[state.step];
      UI.stepCount.textContent = `æ­¥éª¤ ${state.step + 1} / ${tasks.length}`;
      UI.taskText.innerHTML = t.text;
      UI.taskHint.textContent = t.hint;
    }
  }, 600);
}

/* ====== æŒ‰é’®åŠŸèƒ½ ====== */
function resetAll() {
  state.force = 0;
  state.step = 0;
  state.completed = false;
  state.autoMode = false;
  state.isDragging = false;
  
  updatePhysics(0);
  
  UI.dots.forEach(d => d.className = 'dot');
  UI.dots[0].classList.add('active');
  UI.stepCount.textContent = "æ­¥éª¤ 1 / 3";
  UI.taskText.innerHTML = tasks[0].text;
  UI.taskHint.textContent = tasks[0].hint;
  UI.modal.style.display = 'none';
  UI.dragHint.style.opacity = 1;
  
  if(!state.freeMode) showToast("å®éªŒå·²é‡ç½®");
}

/* ====== è‡ªåŠ¨æ¼”ç¤º (Script Error ä¿®å¤ç‰ˆ) ====== */
async function autoDemo() {
  if (state.autoMode) return;
  state.autoMode = true;
  document.getElementById('freeBtn').disabled = true;
  
  resetAll();
  
  const sleep = ms => new Promise(r => setTimeout(r, ms));
  const animateTo = async (targetVal, duration) => {
    const startVal = state.force;
    const steps = 60;
    const dt = duration / steps;
    for (let i=1; i<=steps; i++) {
      if (!state.autoMode) break; // ä¸­æ–­ä¿æŠ¤
      const v = startVal + (targetVal - startVal) * (i/steps);
      updatePhysics(v);
      await sleep(dt);
    }
  };

  UI.scaleLeft.classList.add('highlight');

  // Task 1: 50N
  await sleep(500);
  await animateTo(50, 1000);
  await sleep(800);
  // æ‰‹åŠ¨è§¦å‘æ­¥éª¤å®Œæˆï¼Œä¸ä¾èµ– physics checkï¼Œé˜²æ­¢ç«æ€
  completeStepAuto(); 
  await sleep(800); 

  // Task 2: 150N
  await animateTo(150, 1200);
  await sleep(1000);
  completeStepAuto();
  await sleep(800);

  // Task 3: 30N
  await animateTo(30, 1500);
  await sleep(1200);
  completeStepAuto();
  
  await sleep(500);
  await animateTo(0, 500); // æ¾æ‰‹
  
  UI.scaleLeft.classList.remove('highlight');
  state.autoMode = false;
  document.getElementById('freeBtn').disabled = false;
}

// ä¸“é—¨ä¸ºè‡ªåŠ¨æ¼”ç¤ºè®¾è®¡çš„æ­¥éª¤å®Œæˆå‡½æ•°ï¼Œæ— å‰¯ä½œç”¨
function completeStepAuto() {
  if (state.step >= tasks.length) return;
  showCheck();
  UI.dots[state.step].classList.remove('active');
  UI.dots[state.step].classList.add('done');
  state.step++;
  
  if (state.step >= tasks.length) {
    state.completed = true;
    showDone();
  } else {
    UI.dots[state.step].classList.add('active');
    const t = tasks[state.step];
    UI.stepCount.textContent = `æ­¥éª¤ ${state.step + 1} / ${tasks.length}`;
    UI.taskText.innerHTML = t.text;
    UI.taskHint.textContent = t.hint;
  }
}

/* ====== è¾…åŠ©UI ====== */
function showToast(msg) {
  UI.toast.textContent = msg;
  UI.toast.classList.add('show');
  setTimeout(() => UI.toast.classList.remove('show'), 1500);
}
function showCheck() {
  UI.check.classList.add('active');
  setTimeout(() => UI.check.classList.remove('active'), 600);
}
function showDone() { UI.modal.style.display = 'flex'; }

document.getElementById('resetBtn').onclick = resetAll;
document.getElementById('autoDemoBtn').onclick = autoDemo;
document.getElementById('okBtn').onclick = () => UI.modal.style.display = 'none';
document.getElementById('freeBtn').onclick = () => {
  state.freeMode = !state.freeMode;
  const btn = document.getElementById('freeBtn');
  const card = document.getElementById('taskCard');
  if (state.freeMode) {
    btn.textContent = "é€€å‡ºè‡ªç”±æ¨¡å¼";
    card.style.opacity = 0.3;
    card.style.pointerEvents = 'none';
    showToast("è‡ªç”±æ¨¡å¼ï¼šè¯·å°½æƒ…æ‹‰åŠ¨æµ‹åŠ›è®¡");
  } else {
    btn.textContent = "è‡ªç”±æ¨¡å¼";
    card.style.opacity = 1;
    card.style.pointerEvents = 'auto';
    resetAll();
  }
};

// Init
updatePhysics(0);
</script>
</body>
</html>
